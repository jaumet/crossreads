<!doctype html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>Crossreads, towards to a rhizomatic narrative</title>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="">
  <meta name="author" content="">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <link rel="shortcut icon" href="images/icon.png">
  <link href="css/bootstrap.min.css" rel="stylesheet">
  <link href="css/jumbotron.css" rel="stylesheet">
  <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
  <script src="js/html5shiv.js"></script>
  <script src="js/respond.min.js"></script>
  <![endif]-->
  <link rel="stylesheet" href="css/jquery.fancybox.css" type="text/css" media="screen" />
  
  <script>
    var IMG_PATH = "data/images/";

    if (navigator.userAgent.match(/IEMobile\/10\.0/)) {
      var msViewportStyle = document.createElement('style')
      msViewportStyle.appendChild(
        document.createTextNode('@-ms-viewport{width:auto!important}')
      )
      document.querySelector('head').appendChild(msViewportStyle)
    }
  </script>

  <!--[if lte IE 9]>
  <div id="warning">
  <h4 class="red">Aquest navegador no funciona b&eacute; en aquesta web.<br />Este navegador no funciona correctament en esta web. <br />Your Browser Is Not Supported!</h4><br />
  <p>Si us plau, actualitzeu el navegador.<br /> Por favor, actualice su navegador.<br />Please upgrade your browser</p>
<p><a href='http://getfirefox.com'>FireFox</a>, <a href='http://www.opera.com/download/'>Opera</a>, <a href='http://www.apple.com/safari/'>Safari</a> or <a href="https://www.google.com/intl/en/chrome/browser/">Chrome</a>. Thank You!&nbsp;&nbsp;&nbsp;<a href="#" onClick="document.getElementById('warning').style.display = 'none';"><b>Close Window</b></a></p>
  </div>
  <![endif]-->

  <!-- start crossreads files -->
  <link href='http://fonts.googleapis.com/css?family=Bitter' rel='stylesheet' type='text/css'>
  <link href="css/style.css" rel="stylesheet">
  <script type='text/javascript' src='data/mylang.js'></script>
  <script type="text/javascript" src="data/data.js"></script>
  <!--<script type='text/javascript' src='data/sim.js'></script>-->
  <script type='text/javascript' src='data/sim1.js'></script>
  <!-- end crossreads files -->
</head>
<body>
 <div class="wrapper">
  <div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
      <div class="navbar-header">
        <a class="navbar-brand" href="."><span id="mytitle"><b>Crossreads</b>, towards to a rhizomatic narrative</span></a>
        <a class="navbar-brand" href="#"><span id="about" class="other">About</span></a>
        <a class="navbar-brand" href="#" onClick="window.open('feedbackform/form.php','feedbackform','width=600,height=550,toolbar=no,location=no,directories=no,status=no,menubar=no,scrollbars=yes,copyhistory=no,resizable=yes')"><span id="feedback" class="othercomment">Comenta</span></a>
        <!--<a class="navbar-brand" href="#"><span id="bio" class="other">Biografia</span></a>-->
        <!--<a class="navbar-brand lang" href="?l=ca">Catal&agrave;</a><a class="navbar-brand lang" href="?l=es">Castellano</a>-->
      </div>
    </div>
  </div>
  <!-- Main jumbotron for the texts timelime/overview -->
  <div class="jumbotron">
    <div class="container">
      <table class="mytimeline">
      <tr>
        <td id="2005">
           <c id="22_0" class="t4">.</c>
           <c id="16_0" class="t4">.</c>
           <c id="14_0" class="t4">.</c>
           <c id="6_0" class="t3">.</c>
           <c id="3_0" class="t1">.</c>
        </td>
        <td id="2006">
           <c id="20_0" class="t2">.</c>
           <c id="8_0" class="t4">.</c>
           <c id="7_0" class="t3">.</c>
           <c id="5_0" class="t1">.</c>
        </td>
        <td id="2007">
           <c id="11_0" class="t4">.</c>
           <c id="10_0" class="t1">.</c>
           <c id="9_0" class="t3">.</c>
        </td>
        <td id="2008">
           <c id="15_0" class="t3">.</c>
           <c id="13_0" class="t3">.</c>
           <c id="12_0" class="t1">.</c>
           <c id="24_0" class="t4">.</c>
        </td>
        <td id="2009">
           <c id="21_0" class="t2">.</c>          
           <c id="19_0" class="t2">.</c>
           <c id="18_0" class="t3">.</c>
           <c id="17_0" class="t3">.</c>
           <c id="4_0" class="t2">.</c>
        </td>
        <td id="2010">
           <c id="29_0" class="t3">.</c>
           <c id="28_0" class="t4">.</c>
           <c id="27_0" class="t2">.</c>
           <c id="26_0" class="t3">.</c>
           <c id="25_0" class="t3">.</c>
           <c id="23_0" class="t3">.</c>
        </td>
        <td id="2011">
           <c id="2_0" class="t2">.</c>
           <c id="1_0" class="t2">.</c>
        </td>
      </tr>
      <tr>
        <td>2005</td><td>2006</td><td>2007</td><td>2008</td><td>2009</td><td>2010</td><td>2011</td>
      </tr>        
      </table>
      <div class="legend">
        <span><b>29 <span id="mytexts">textos</span></b>
        <br /><br />
        <span id="myt3" class="t3c" style="font-size:16px;">Opinion</span><br /> 
        <span id="myt4" class="t4c" style="font-size:14px;">Interview</span><br />
        <span id="myt2" class="t2c" style="font-size:14px;">Presentation</span><br />
        <span id="myt1" class="t1c" style="font-size:11px;">Catalogue</span>
      </span></div>
      <div class="legend">
          <span id="help_timeline">To explore texts<br />click colored points</span>
      </div>
    </div>
  </div>
  <!-- other pages container -->  
  <div id="otherpages" class="container"></div>
  
  <!-- top reader container -->  
  <div id="mytopmetadata" class="container">
    <p id="my_youarereading" class="mytag"></p>
    <p id="title"></p>
    <div id="toparrow" class="arrowt"></div>
  </div>

  <!-- main reader container: row of three columns -->
  <div id="reader" class="container">
    <div class="row">

      <div id="myleftcolumn" class="col-md-3">
        <p></p>
        <div id="bottomleft" class="mybottom">
          <div class="arrowl"></div>
        </div>
      </div>

      <div id="mycentercolumn" class="col-md-5">
        <div id="text"></div>
      </div>

      <div id="myrightcolumn" class="col-md-3">
        <p><img src="images/help.png" width="25px" /><span id="myarrows" class="grey"></span></p>
        <p id="myfootnotes"></p>
        <div id="bottomright" class="mybottom">
          <div class="arrowr"></div>
        </div>
      </div>
      
    </div>
  </div>

  <!-- bottom reader container -->
  <div id="mybottommetadata" class="container"></div>
  <div id="allTextWrapper" style="display:block"></div>

  <!-- footer -->
  <div id="mynotes">
    <div id="mystore"></div>
    <div id="wname"></div>
  </div>
  <footer>
     <p><a href="." target="_macba"><img src="images/icon.png" width="40px" /></a>&nbsp;&nbsp;&nbsp;Crossreads is published under free licenses:  Software [<a href="http://www.gnu.org/copyleft/gpl.html" target="gpl">GPL</a>] & Texts [<a href="http://creativecommons.org/licenses/by-nc-nd/3.0/deed.ca" target="creative_commons">CC-BY-NC-ND</a>]. Canberra (AU), 2014.
     <span id="mytweet"><a href="https://twitter.com/share" class="twitter-share-button" data-url="." data-text="Crossreads: a tool for non-linear reading" data-via="jaumetet" data-count="none" data-hashtags="tsio2014">Tweet</a></span>
     <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script></p>
  </footer>
 </div> <!--wrapper div close-->
  
  <!-- starts core JavaScript libs -->
  <script src="js/jquery-1.11.0.min.js"></script>
  <script src="js/underscore-min.js"></script>
  <script src="js/jquery.fancybox.pack.js"></script>
  <!-- ends JavaScript libs -->

  <script>
    // Comment or uncomment
    // it calculates font-size  for the topics of the timeline
    /*
    tt= [4, 7, 11, 7];        
    var total = 0;
    $.each(tt, function(i, v) {
      total += v;
    });
    tt1 = 10*tt[0]/total;
    tt2 = 10*tt[1]/total;
    tt3 = 10*tt[2]/total;
    tt4 = 10*tt[3]/total;
    console.log ("TOTAL= "+total+" || tt1= "+tt1+" | tt2= "+tt2+" | tt3= "+tt3+" | tt4= "+tt4);     
    //TOTAL= 29 || tt1= 1.3793103448275863 | tt2= 2.413793103448276 | tt3= 3.793103448275862 | tt4= 2.896551724137931 
    */
  </script>

  <!-- starts crossreads business -->
  <script>
  function loadMetadataIn(tid, mydiv, main)  {
    var meta_title = "";
    var meta_rest = "";
    var meta_img = "";
    var meta_html = "";
    var alltext ='<p><a id="'+tid+'" href="#" class="all-text" ><span id="allText">Full text view</span></a></p>';
    $.each( METADATA, function( key, val )  {
      if (val.tid == tid)  {
        meta_title = "<h2>"+val.tid+" - "+val.title+"</h2>";
        // Check for images attached to tid
        if (val.images.length > 0) { // FIXME for more than one image
          meta_img = alltext+'<a class="fancybox" rel="group" href="'+IMG_PATH+val.images[0]+'"><img src="'+IMG_PATH+val.images[0]+'" /></a>';
        } else {
          meta_img = alltext;
        }
        meta_rest = '('+val.year+') '+val.publication+'<br />'+val.category+'  '+val.type;
        meta_year = '['+val.year+'] ';
        // Check if this is the main title-box
        if (main == "main")  {
          meta_html = '<div class="list-group">\
            <a id="'+val.tid+'_0" href="#" class="node list-group-item active">\
            <h4 class="list-group-item-heading">'+meta_title+'</h4>\
            <p class="mymeta">'+meta_rest+'</p></a>\
            </div>';
          $("#my_youarereading").css({"display":"block"});
          $("#myleftcolumn p").html(meta_img);
        } else {
          meta_html = '<div class="jump"><b>'+val.title+'</b><br /><span>'+meta_year+'</span></div>';
        }
      }
    });

    $(mydiv).html(meta_html);
    // Preparing smooth animate() for #text and #title
    $("#title h2").css({ "opacity": "0" });
    $("#text p").css({ "opacity": "0" });
    $("#myleftcolumn").promise().done(function(){
      $("a.all-text").on('click', function() {
          allText(tid, METADATA);
      });
    });
  }

  function loadLeftAndRightLinks(myIndex, sim1) {
    // Right similar segment
    var sim = _.keys(sim1)
    // Link quality:
    var linkQuality =  sim1[myIndex];
    var target = linkQuality["target"];
    // Kind of Entity:
    var Epersons = linkQuality["perScore"];
    var Edate = linkQuality["dateScore"];
    var Elocation = linkQuality["locScore"];
    var Eunknown = linkQuality["unkScore"];
    var myEntities = "";
    if( Epersons > 0) {myEntities += '<img src="images/glyphicons_043_group.png" alt="persons" />';}
    if( Edate > 0) {myEntities += '<img src="images/glyphicons_054_clock.png" alt="persons" />';}
    if( Elocation > 0) {myEntities += '<img src="images/glyphicons_242_google_maps.png" alt="persons" />';}
    if( Eunknown > 0) {myEntities += '<img styleX="background-color:#ffffff;" src="images/glyphicons_194_circle_question_mark.png" alt="persons" />';}
console.log("MYINDEX: "+myIndex+" | TARGET = "+target);    
    $("#bottomright div").html('<a href="#" id="'+target+'" class="arrow"><img src="images/w_right_arrow.png" /><i>Similar text</i> - '+target+'<br />'+myEntities+'<span></span></a>');

    // Left random segment:
    var leftIndex = sim[_.random(sim.length-1)];
    console.log("LEFT INDEX: "+leftIndex);
    $("#bottomleft div").html('<a href="#" id="'+leftIndex+'" class="arrow"><i>Random text</i><img src="images/dice.png" /></a><span></span>');

    // Right and left title boxes
    myr = myIndex.split('_');
    loadMetadataIn(myr[0], "#bottomright div span", "right");
  }

  function putParagraphIn(myIndex, mydiv)  {
    my = myIndex.split('_');
	  tid = my[0];
	  pid = my[1];
	  $.getJSON( "data/texts/"+tid+".json", function( data ) {
	    var items = [];
      var footnote = [];
      $.each( data, function( key, val ) {
        items.push('<div class="xofy">'+ (parseInt(val.pid)+1) +' <span id="xofy">de</span> '+data.length+'</div><p id="p_' + val.pid + '" class="paragraph">' + val.p + '</p>');
        // Check for footnotes
        if (!(_.isUndefined(val.fn))) {
          footnote.push(val.fn);
        }  else {
          footnote.push('');
        }
      });
      $(mydiv).css({ "opacity": "0" });
      $(mydiv).html(myIndex+items[pid]);
      var footNotesHelp = eval('lang_'+LANGUAGE);
      if (footnote[parseInt(pid)] != '')  {
        $("#myfootnotes").html('<span id="footnotes" class="grey">'+footNotesHelp["footnotes"]+'</span><br />'+footnote[parseInt(pid)]);
      } else {
        $("#myfootnotes").html('');
      }
      $(mydiv).animate({ "opacity": "1" }, 1300 );
      $("#title h2").animate({ "opacity": "1" }, 1300 );
      $("#mystore").html(data.length);
    });
    return $("#mystore").html();
  }

  function allText(tid, meta)  {
    mytext = '<div id="showAllText"><div id="closeAllText"><img id="close" src="images/w_close.png" /></div><h1>'+$("#title h2").html()+'</h1>';
    $.getJSON( "data/texts/"+tid+".json", function( data ) {
      $.each( data, function( key, val ) {
        mytext += '<p>'+val.p+'</p>';
      });
      mytext += '</div>';
      if ($("#allTextWrapper").html() == '' ) {
        $("#allTextWrapper").html(mytext);
      }
      $("#allTextWrapper").addClass("allTextWrapper");
      $("#showAllText").addClass("allTextBox");
    });
    return treu;
  }
  
  function sleep(milliseconds) {
    var start = new Date().getTime();
    for (var i = 0; i < 1e7; i++) {
      if ((new Date().getTime() - start) > milliseconds){
        break;
      }
    }
  }

  // MAIN function
  function myTrick(myid) {
    $("#otherpages").animate({ "opacity": "0" }, 1300 );
    $("#otherpages").css({"display":"none"});
    $("#otherpages").html(""); // Clean other pages
    my = (myid).split('_');
    tid = my[0];
    pid = my[1];
    if (_.isUndefined(pid) || pid == "NaN") {
      pid = "1";
      tid = myid;
    }	
    window.name += " | "+tid+"_"+pid;	
    $("#wname").append(" | "+tid+"_"+pid);
	
    loadMetadataIn(tid, "#title", "main");
    putParagraphIn(tid+"_"+pid, "#text");

    // Show whole-text
    $("#myleftcolumn").promise().done(function(){
      
      $("html").on('click', function(e) {
        if (e.target.id == 'close' || (e.target.id != 'showAllText' && e.target.id != '')) {
          $("#allTextWrapper").removeClass("allTextWrapper");
          $("#showAllText").removeClass("allTextBox");
          $("#allTextWrapper").html('');
        }
      });
      $(document).on( 'keydown', function ( e ) {
        if ( e.keyCode === 27 ) { // key ESC
          $("#allTextWrapper").removeClass("allTextWrapper");
          $("#showAllText").removeClass("allTextBox");
          $("#allTextWrapper").html('');
        }
      });
      
    });

    // top & bottom arrows checking
    $("#mystore").promise().done(function(){
      if (parseInt(pid) == 0)  {
        c = 0;
        $.getJSON( "data/texts/"+tid+".json", function( data ) {
          $.each( data, function( key, val ) {
            c = c + 1;
          });
        });
        mypidTop = c;
      } else {
        mypidTop = parseInt(pid)-1;
      }
      myidTop = tid+"_"+mypidTop;
      
      if ((parseInt(pid) + 1) == parseInt($("#mystore").text()))  {
        mypidBottom = "0";
      } else {
        mypidBottom = parseInt(pid) + 1;
      }
      var myidBottom = tid+"_"+mypidBottom;
      var myArrowsHelp = eval('lang_'+LANGUAGE);
      $("#myrightcolumn p").first().html('<span id="myarrows">'+myArrowsHelp["myarrows"]+'</span></p><p><a href="#" id="'+myidTop+'" class="arrowt"><img src="images/w_top_arrow.svg" /></a><a href="#" id="'+myidBottom+'" class="arrowb"><img src="images/w_bottom_arrow.svg" /></a>');
      $("a.node, a.arrowt, a.arrowb").on('click', function() {
        myTrick(this.id);
        return false;
      });
    });

    // left & right arrows checking
    $("div.arrow").html('').promise().done(function(){
      // Get the id of the text on the centre ;-)
      var sim = _.keys(sim1)
      //myIndex = _.indexOf(sim, tid+"_"+pid);
      //loadLeftAndRightLinks(myIndex, sim1);
      loadLeftAndRightLinks(tid+"_"+pid, sim1);
      $("a.arrow").on('click', function() {
        $("c").css({"border":"0 solid yellow"});
        myid = this.id;
        myid = myid.split('_');
        $("#"+myid[0]+"_0").css({"border":"3px solid yellow"});
        myTrick(this.id);
        return false;
      });
    });
  }

  // Load fancybox 
  $(document).ready(function() {
    $("a.all-text").on('click', function() {
      allText(tid, METADATA);
    });
        
    // Timeline, arrow and title click capture
    $("a.node, a.arrow").on('click', function() {
      $("c").css({"border":"0 solid yellow"});
      $("#"+this.id).css({"border":"3px solid yellow"});
      $("#myrightcolumn, #mycentercolumn, #myleftcolumn").css({"display":"block"});
      myTrick(this.id);
      return false;
    });
    
    $("c, a.text-list").on('click', function() {
      $("html, body").animate({ scrollTop: 165 }, "slow");
      $("c").css({"border":"1px solid"});
      $("#"+this.id).css({"border":"1px solid yellow"});
      $("#myrightcolumn, #mycentercolumn, #myleftcolumn").css({"display":"block"});
      myTrick(this.id);
      return false;
    });

    $(".fancybox").fancybox();
    $(".fancybox2").fancybox();
    return false;
  });

  //////////////////////////////////////////////
  // Languages: 
  // lang object is defined in data/mylang.js
  // each string is defined as: "element id": "text string"
  function getParameterByName(name) {
    return decodeURIComponent((new RegExp('[?|&]' + name + '=' + '([^&;]+?)(&|#|;|$)').exec(location.search)||[,""])[1].replace(/\+/g, '%20'))||null;
  }

  var LANGUAGE = getParameterByName("l");
  if (LANGUAGE == "ca" || LANGUAGE == undefined) { LANGUAGE = "ca";}
  if (LANGUAGE == "es" ){ LANGUAGE = "es";}
  if (LANGUAGE != "ca" && LANGUAGE != "es") { LANGUAGE = "ca";}

  function langStrings(lang)  { 
    $.each(lang, function(key, value){
      $("#"+key).html(value);
    });
  } 
  currentLang = eval("lang_"+LANGUAGE);
  langStrings(currentLang);
  $("#my_youarereading").css({"display":"none"});
  // End Languages
  ///////////////////////

  ////////////////////////////
  // Other pages click/load:
  // Load page-default initially:
  $("#otherpages").html(currentLang["page-default"]+currentLang["textList"]);  
  $("span.other").on('click', function() {
    $("#otherpages").css({"display":"block"});
    $("#otherpages").html(currentLang["page-"+this.id]);
    $("#otherpages").animate({ "opacity": "1" }, 1300 );
    $("#close").on('click', function() {
      if ($("#title").html() != '') {
        $("#otherpages").animate({ "opacity": "0" }, 1300 );
        $("#otherpages").html('');
        $("#otherpages").css({"display":"none"});
      } else {
        $("#otherpages").html(currentLang["page-default"]+currentLang["textList"]);
        $("#otherpages").animate({ "opacity": "1" }, 1300 );
      }
    });
    return false;
  });
  
  // Filters for list of texts
   $("p.myfilters span:not(:first), my").on('click', function() {
    filter = $(this).data("cat");
    if (filter == "all") {
      // Show all
      $("li[data-cat]").css("display","block")
      $("p.myfilters span:not(:first)").css("border","0 solid");
    } else {
      // hide all items:
      $("li[data-cat]").css("display","none")
      $("p.myfilters span:not(:first)").css("border","0 solid");
      // show only the filter
      $("li[data-cat="+filter+"]").css("display","block");
      $(this).css("border", "1px solid");
    }
  });

  // End Other pages
  ///////////////////////
  
  </script>
  <!-- ends crossreads business -->
</body>
</html>
